"use strict";function n(n){return n&&"object"==typeof n&&"default"in n?n.default:n}var e=require("apollo-server-lambda"),t=n(require("uuid/v4")),i=n(require("aws-sdk"));let r=new i.DynamoDB.DocumentClient;"dev"===process.env.STAGE&&(r=new i.DynamoDB.DocumentClient({region:"localhost",endpoint:`http://localhost:${process.env.DYNAMODB_PORT}`,accessKeyId:"DEFAULT_ACCESS_KEY",secretAccessKey:"DEFAULT_SECRET"}));let o=process.env.RECIPE_TABLE,s=process.env.USERS_TABLE;const a=n=>new Promise((e,t)=>{n((n,i)=>{n?t(n):e(i)})}),p={Query:{recipe:async(n,{id:e})=>{var t,i;return null===(i=null===(t=await a(n=>{const t={TableName:o,KeyConditionExpression:"id = :recipeId",ExpressionAttributeValues:{":recipeId":e}};r.query(t,n)}))||void 0===t?void 0:t.Items)||void 0===i?void 0:i[0]},recipes:async()=>{var n;return null===(n=await a(n=>{const e={TableName:o};r.scan(e,n)}))||void 0===n?void 0:n.Items},user:async(n,{id:e})=>{var t,i,p;const g=null===(i=null===(t=await a(n=>{const t={TableName:s,KeyConditionExpression:"id = :userId",ExpressionAttributeValues:{":userId":e}};r.query(t,n)}))||void 0===t?void 0:t.Items)||void 0===i?void 0:i[0],u=g.cookbooks[0].recipes,c=null===(p=await a(n=>{const e={RequestItems:{[o]:{Keys:u.map(n=>({id:n}))}}};r.batchGet(e,n)}))||void 0===p?void 0:p.Responses[o];return g.cookbooks[0].recipes=c,g}},Mutation:{createRecipe:async(n,{recipe:e},i)=>{const s=Object.assign({id:t(),createdAt:(new Date).toISOString(),author:i.user.name},e);return await a(n=>{const e={TableName:o,Item:s};r.put(e,n)}),s}}},g=async({requestContext:{authorizer:n}})=>{if(n){const n={name:"Panayiotis"};if(n)return n}return null},u=new e.ApolloServer({typeDefs:"\n  input RecipeInput {\n    name: String!\n    image: String\n    preparationTime: Int\n    cookingTime: Int\n    portions: String\n    difficulty: String\n    ingredients: [IngredientInput]\n    items: [ItemInput]\n    steps: [StepInput]\n    notes: [String]\n  }\n\n  input IngredientInput {\n    qty: String!\n    name: String!\n    notes: String\n    link: String\n  }\n\n  input ItemInput {\n    qty: String!\n    name: String!\n    notes: String\n    link: String\n  }\n\n  input LinkInput {\n    heading: String\n    name: String!\n    from: Int!\n    timerId: String\n  }\n\n  input TagInput {\n    text: String!\n    color: String!\n  }\n\n  input ImageInput {\n    src: String\n    alt: String\n  }\n\n  input TimerInput {\n    id: String!\n    name: String!\n    minutes: Int!\n    seconds: Int!\n  }\n\n  input StepInput {\n    no: Int\n    type: StepType!\n    links: [LinkInput]\n    tag: TagInput\n    items: [ItemInput]\n    ingredients: [IngredientInput]\n    tasks: [TaskInput]\n    images: [ImageInput]\n    timer: TimerInput\n  }\n\n  input TaskInput {\n    name: String!\n    notes: [String]\n  }\n\n  type Recipe {\n    id: String\n    author: String\n    createdAt: String\n    name: String\n    image: String\n    preparationTime: Int\n    cookingTime: Int\n    portions: String\n    difficulty: String\n    notes: [String]\n    ingredients: [Ingredient]\n    items: [Item]\n    steps: [Step]\n  }\n\n  type Ingredient {\n    qty: String\n    name: String\n    notes: String\n    link: String\n  }\n\n  type Item {\n    qty: String\n    name: String\n    notes: String\n    link: String\n  }\n\n  enum StepType {\n    MISE_EN_PLACE\n    PREPARATION\n  }\n\n  type Step {\n    no: Int\n    type: StepType\n    links: [Link]\n    tag: Tag\n    items: [Item]\n    ingredients: [Ingredient]\n    tasks: [Task]\n    images: [Image]\n    timer: Timer\n    notes: [String]\n  }\n\n  type Task {\n    name: String!\n    notes: [String]\n  }\n\n  type Link {\n    heading: String\n    name: String!\n    from: String!\n    timerId: String\n  }\n\n  type Tag {\n    text: String!\n    color: String!\n  }\n\n  type Image {\n    src: String!\n    alt: String\n  }\n\n  type Timer {\n    id: String!\n    name: String!\n    minutes: Int!\n    seconds: Int!\n  }\n\n  type Cookbook {\n    id: String!\n    name: String!\n    recipes: [Recipe!]!\n  }\n\n  type User {\n    id: String!\n    createdAt: String!\n    firstName: String\n    lastName: String\n    email: String\n    cookbooks: [Cookbook!]!\n  }\n\n  type Query {\n    user(id: String!): User!\n    recipes: [Recipe!]!\n    recipe(id: String!): Recipe!\n  }\n\n  type Mutation {\n    createRecipe(recipe: RecipeInput!): Recipe!\n  }\n\n  type schema {\n    query: Query\n    mutation: Mutation\n  }\n",resolvers:p,formatError:n=>(console.log(n),n),formatResponse:n=>(console.log(n),n),context:async({event:n,context:e})=>({headers:n.headers,functionName:e.functionName,event:n,context:e,user:await g(n)}),playground:{endpoint:"prod"===process.env.STAGE?"/prod/graphql":"/dev/graphql"},tracing:!0});exports.graphqlHandler=u.createHandler({cors:{origin:"*"}});
