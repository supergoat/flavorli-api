"use strict";function n(n){return n&&"object"==typeof n&&"default"in n?n.default:n}var e=require("apollo-server-lambda"),t=n(require("aws-sdk")),i=n(require("uuid/v4"));let r=new t.DynamoDB.DocumentClient;"dev"===process.env.STAGE&&(r=new t.DynamoDB.DocumentClient({region:"localhost",endpoint:`http://localhost:${process.env.DYNAMODB_PORT}`,accessKeyId:"DEFAULT_ACCESS_KEY",secretAccessKey:"DEFAULT_SECRET"}));const s=async n=>{var e,t;return null===(t=null===(e=await r.query(n).promise())||void 0===e?void 0:e.Items)||void 0===t?void 0:t[0]},a=async n=>{var e;return null===(e=await r.scan(n).promise())||void 0===e?void 0:e.Items},o=async n=>{var e;return null===(e=await r.batchGet(n).promise())||void 0===e?void 0:e.Responses},p=async n=>{await r.query(n).promise();return n.Item};let g=process.env.RECIPE_TABLE;let u=process.env.RECIPE_TABLE,c=process.env.USERS_TABLE;const S={Query:{recipe:async(n,{id:e})=>s({TableName:g,KeyConditionExpression:"id = :recipeId",ExpressionAttributeValues:{":recipeId":e}}),recipes:async()=>a({TableName:g}),user:async(n,{id:e})=>{var t;const i={TableName:c,KeyConditionExpression:"id = :userId",ExpressionAttributeValues:{":userId":e}},r=await s(i),a=null===(t=r)||void 0===t?void 0:t.cookbooks[0].recipes,p={RequestItems:{[u]:{Keys:a.map(n=>({id:n}))}}},g=(await o(p))[u];return r.cookbooks[0].recipes=g,r}},Mutation:{createRecipe:async(n,{recipe:e},t)=>{const r={TableName:g,Item:Object.assign({id:i(),createdAt:(new Date).toISOString(),author:t.user.name},e)};return await p(r)}}},m=async({requestContext:{authorizer:n}})=>{if(n){const n={name:"Panayiotis"};if(n)return n}return null},d=new e.ApolloServer({typeDefs:"\n  input RecipeInput {\n    name: String!\n    image: String\n    preparationTime: Int\n    cookingTime: Int\n    portions: String\n    difficulty: String\n    ingredients: [IngredientInput]\n    items: [ItemInput]\n    steps: [StepInput]\n    notes: [String]\n  }\n\n  input IngredientInput {\n    qty: String!\n    name: String!\n    notes: String\n    link: String\n  }\n\n  input ItemInput {\n    qty: String!\n    name: String!\n    notes: String\n    link: String\n  }\n\n  input LinkInput {\n    heading: String\n    name: String!\n    from: Int!\n    timerId: String\n  }\n\n  input TagInput {\n    text: String!\n    color: String!\n  }\n\n  input ImageInput {\n    src: String\n    alt: String\n  }\n\n  input TimerInput {\n    id: String!\n    name: String!\n    minutes: Int!\n    seconds: Int!\n  }\n\n  input StepInput {\n    no: Int\n    type: StepType!\n    links: [LinkInput]\n    tag: TagInput\n    items: [ItemInput]\n    ingredients: [IngredientInput]\n    tasks: [TaskInput]\n    images: [ImageInput]\n    timer: TimerInput\n  }\n\n  input TaskInput {\n    name: String!\n    notes: [String]\n  }\n\n  type Recipe {\n    id: String\n    author: String\n    createdAt: String\n    name: String\n    image: String\n    preparationTime: Int\n    cookingTime: Int\n    portions: String\n    difficulty: String\n    notes: [String]\n    ingredients: [Ingredient]\n    items: [Item]\n    steps: [Step]\n  }\n\n  type Ingredient {\n    qty: String\n    name: String\n    notes: String\n    link: String\n  }\n\n  type Item {\n    qty: String\n    name: String\n    notes: String\n    link: String\n  }\n\n  enum StepType {\n    MISE_EN_PLACE\n    PREPARATION\n  }\n\n  type Step {\n    no: Int\n    type: StepType\n    links: [Link]\n    tag: Tag\n    items: [Item]\n    ingredients: [Ingredient]\n    tasks: [Task]\n    images: [Image]\n    timer: Timer\n    notes: [String]\n  }\n\n  type Task {\n    name: String!\n    notes: [String]\n  }\n\n  type Link {\n    heading: String\n    name: String!\n    from: String!\n    timerId: String\n  }\n\n  type Tag {\n    text: String!\n    color: String!\n  }\n\n  type Image {\n    src: String!\n    alt: String\n  }\n\n  type Timer {\n    id: String!\n    name: String!\n    minutes: Int!\n    seconds: Int!\n  }\n\n  type Cookbook {\n    id: String!\n    name: String!\n    recipes: [Recipe!]!\n  }\n\n  type User {\n    id: String!\n    createdAt: String!\n    firstName: String\n    lastName: String\n    email: String\n    cookbooks: [Cookbook!]!\n  }\n\n  type Query {\n    user(id: String!): User!\n    recipes: [Recipe!]!\n    recipe(id: String!): Recipe!\n  }\n\n  type Mutation {\n    createRecipe(recipe: RecipeInput!): Recipe!\n  }\n\n  type schema {\n    query: Query\n    mutation: Mutation\n  }\n",resolvers:S,formatError:n=>(console.log(n),n),formatResponse:n=>(console.log(n),n),context:async({event:n,context:e})=>({headers:n.headers,functionName:e.functionName,event:n,context:e,user:await m(n)}),playground:{endpoint:"prod"===process.env.STAGE?"/prod/graphql":"/dev/graphql"},tracing:!0});exports.graphqlHandler=d.createHandler({cors:{origin:"*"}});
